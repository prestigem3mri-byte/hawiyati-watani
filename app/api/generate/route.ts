import OpenAI from "openai";

export const runtime = "nodejs";

export async function POST(req: Request) {
  try {
    const { grade, lesson, questions } = await req.json();

    if (!grade || !lesson || !questions) {
      return Response.json({ error: "Missing required fields" }, { status: 400 });
    }

    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      return Response.json(
        { error: "OPENAI_API_KEY is not set in .env.local" },
        { status: 500 }
      );
    }

    const prompt = `
أنت معلم متخصص في إعداد أوراق عمل لمادة الهوية والمواطنة للصفوف (1–4) في سلطنة عمان.

المعطيات:
- الصف: ${grade}
- عنوان الدرس: ${lesson}
- عدد الأسئلة الكلي: ${questions}

قواعد إلزامية:
- ممنوع ذكر اسم أي مدرسة أو اسم شخص أو اسم معلم/معلمة داخل الورقة.
- لا تكتب الإجابات نهائيًا.
- لغة عربية مبسطة مناسبة لعمر الصف.
- اكتب الورقة بشكل رسمي وجاهز للطباعة.
- لا تستخدم أقواس داخل الورقة نهائيًا. لا تكتب كلمات مثل: سطر واحد، عدة أسطر، ضع دائرة، للمعلم.
- اترك مساحات للإجابة باستخدام خطوط فقط مثل: ____________________ أو ______________________________________

اكتب الورقة بالنمط التالي حرفيًا:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
وزارة التعليم
مادة: الهوية والمواطنة
هوية وطني – أوراق عمل ذكية
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

اسم الطالب/ـة: ______________________    الصف: ${grade}    الشعبة: ________
عنوان الدرس: ${lesson}
التاريخ: ____ / ____ / ______          الزمن: ______ دقيقة

التعليمات:
أجب عن الأسئلة في المكان المخصص.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
القسم الأول: اختر الإجابة الصحيحة
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- اكتب عددًا مناسبًا من أسئلة الاختيار من متعدد.
- لكل سؤال 4 خيارات (أ، ب، ج، د).
- بعد كل سؤال اترك سطرًا للإجابة.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
القسم الثاني: صح أو خطأ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- اكتب عددًا مناسبًا من أسئلة صح أو خطأ.
- اترك مكانًا للإجابة والتصحيح.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
القسم الثالث: أكمل الفراغ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- اكتب عددًا مناسبًا من أسئلة أكمل الفراغ.
- اترك سطرين للإجابة تحت كل سؤال.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
القسم الرابع: مواقف وقيم المواطنة
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- اكتب عددًا مناسبًا من أسئلة قصيرة عن مواقف يومية.
- اترك 3 أسطر للإجابة تحت كل سؤال.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
القسم الخامس: سؤال تفكير
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- اكتب سؤال تفكير واحد فقط.
- اترك 4 أسطر للإجابة.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
عبارة تشجيعية:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
______________________________________________

مهم جدًا:
- مجموع الأسئلة في جميع الأقسام يجب أن يساوي ${questions} فقط.
- رقّم الأسئلة 1، 2، 3… بوضوح.
- لا تضع أي نص بين أقواس داخل الورقة.

ابدأ بكتابة الورقة الآن وبنفس التنسيق، مع الالتزام بمجموع ${questions} سؤال.
`;

    const client = new OpenAI({ apiKey });

    const completion = await client.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "أنت مساعد تعليمي متخصص في إعداد أوراق عمل مدرسية." },
        { role: "user", content: prompt },
      ],
      temperature: 0.6,
    });

    const text = completion.choices?.[0]?.message?.content ?? "";
    return Response.json({ text });
  } catch (err: any) {
    console.error("API /api/generate error:", err);
    return Response.json(
      { error: "server_error", details: String(err?.message ?? err) },
      { status: 500 }
    );
  }
}
